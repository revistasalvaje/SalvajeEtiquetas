<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de etiquetas postales</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style></style>
</head>
<body>
    <div class="container">
        <h1>Salvajetiquetas</h1>

        <form method="POST">
            <label for="sheet_url">Google Sheets:</label>
            <input type="text" name="sheet_url" id="sheet_url" required>
            <button type="submit">Cargar hoja</button>
        </form>

        {% if error %}<p class="error">{{ error }}</p>{% endif %}
        {% if success %}<p class="success">{{ success }}</p>{% endif %}

        {% if preview %}
        <h2>Editar datos antes de generar etiquetas</h2>
        <form id="editar-form">
            <table class="editable">
                <thead>
                    <tr>
                        {% for col in preview[0].keys() %}<th>{{ col }}</th>{% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in preview %}
                    <tr>
                        {% for key, val in row.items() %}
                        <td>
                            {% if key in ["Internacional", "Enviar"] %}
                                <input type="checkbox" name="{{ key }}" {% if val in [True, 'True', 'true', '1'] %}checked{% endif %}>
                            {% elif key == "Producto" %}
                                <input type="text" name="{{ key }}" value="{{ val|replace('.0', '') }}">
                            {% else %}
                                <input type="text" name="{{ key }}" value="{{ val }}">
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit">Guardar y regenerar PDF</button>
            <button onclick="window.open('/etiquetas_or.pdf', '_blank')">Generar etiquetas OR</button>
        </form>

        <script>
        document.getElementById("editar-form").addEventListener("submit", function(e) {
            e.preventDefault();
            const rows = Array.from(document.querySelectorAll("tbody tr"));
            const headers = Array.from(document.querySelectorAll("thead th")).map(th => th.textContent);
            const data = rows.map(row => {
                const cells = row.querySelectorAll("td input");
                return Object.fromEntries(headers.map((h, i) => {
                    const input = cells[i];
                    if (input.type === "checkbox") return [h, input.checked];
                    return [h, input.value.trim()];
                }));
            });

            fetch("/editar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: data })
            }).then(res => {
                if (res.ok) {
                    const iframe = document.querySelector("iframe");
                    if (iframe) {
                        iframe.src = "/etiquetas.pdf?" + new Date().getTime();
                    }
                }
            });
        });
        </script>
        {% endif %}

        {% if success %}
        <h2>Previsualizaci√≥n de etiquetas</h2>
        <iframe src="{{ url_for('generar_pdf') }}" width="100%" height="600px" style="border:1px solid #ccc;"></iframe>
        {% endif %}
    </div>
</body>
</html>