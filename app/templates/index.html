<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de etiquetas postales</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Salvajetiquetas</h1>
            <p class="subtitle">Generador de etiquetas para envíos postales</p>
        </header>

        <section class="form-section">
            <form method="POST" id="sheets-form">
                <div class="form-group">
                    <label for="sheet_url">URL de Google Sheets:</label>
                    <div class="input-group">
                        <input type="text" name="sheet_url" id="sheet_url" required
                                placeholder="https://docs.google.com/spreadsheets/d/..."
                                pattern=".*docs\.google\.com\/spreadsheets\/d\/.*"
                                title="Introduce una URL válida de Google Sheets">
                        <button type="submit" id="submit-btn">Cargar hoja</button>
                    </div>
                    <small class="form-help">La hoja debe estar compartida con permisos de lectura</small>
                </div>
            </form>
        </section>

        {% if error %}
        <div class="alert error" role="alert">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        {% if success %}
        <div class="alert success" role="alert">
            {{ success }}
        </div>
        {% endif %}

        {% if preview %}
        <section class="data-section">
            <h2>Editar datos antes de generar etiquetas</h2>
            <p class="instructions">Pulsa en los encabezados para ordenar. Revisa y edita los datos antes de imprimir.</p>

            <form id="editar-form">
                <div class="table-container">
                    <table class="editable" id="dataTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">¿Env? <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(1)">Nombre <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(2)">Empresa <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(3)">Dirección <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(4)">CP <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(5)">Ciudad <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(6)">Z <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(7)">Env. <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(8)">País <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(9)">¿Int? <span class="sort-icon">⇅</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in preview %}
                            <tr>
                                <td><input type="checkbox" name="Enviar" {% if row.Enviar in [True, 'True', 'true', '1', 'sí', 'si'] %}checked{% endif %}></td>
                                <td><input type="text" name="Nombre" value="{{ row.Nombre }}"></td>
                                <td><input type="text" name="Empresa" value="{{ row.Empresa }}"></td>
                                <td><input type="text" name="Dirección" value="{{ row.Dirección }}"></td>
                                <td><input type="text" name="CP" value="{{ row.CP }}"></td>
                                <td><input type="text" name="Ciudad" value="{{ row.Ciudad }}"></td>
                                <td><input type="text" name="Zona" value="{{ row.Zona }}"></td>
                                <td><input type="text" name="Producto" value="{{ row.Producto|replace('.0', '') }}"></td>
                                <td><input type="text" name="País" value="{{ row.País }}"></td>
                                <td><input type="checkbox" name="Internacional" {% if row.Internacional in [True, 'True', 'true', '1', 'sí', 'si'] %}checked{% endif %}></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button type="submit" id="save-btn" class="primary">Guardar y regenerar PDF</button>
                </div>
            </form>

            <div id="loading" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <span>Procesando...</span>
            </div>

            <div id="status-message" class="alert" style="display: none;"></div>
        </section>
        {% endif %}

        {% if success %}
        <section class="preview-section">
            <h2>Previsualización y Descarga</h2>
            
            <div class="calibration-panel">
                <h3>Ajustes de Impresión (Calibración)</h3>
                <p class="small-text">Mueve el contenido si las etiquetas no encajan bien en tu papel.</p>
                <div class="calibration-controls">
                    <div class="control-group">
                        <label for="offset-x">↔ Horizontal (mm):</label>
                        <input type="number" id="offset-x" value="0" step="0.5" onchange="updateLinks()">
                        <span class="hint">Positivo = Derecha</span>
                    </div>
                    <div class="control-group">
                        <label for="offset-y">↕ Vertical (mm):</label>
                        <input type="number" id="offset-y" value="0" step="0.5" onchange="updateLinks()">
                        <span class="hint">Positivo = Arriba</span>
                    </div>
                    <button type="button" class="button secondary small" onclick="updateLinks()">Aplicar a Vista Previa</button>
                </div>
            </div>

            <div class="pdf-container">
                <iframe id="pdf-preview" src="{{ url_for('main.generar_pdf') }}" width="100%" height="600px"></iframe>
            </div>
            
            <div class="button-group downloads">
                <a href="{{ url_for('main.generar_pdf') }}" id="btn-download-addr" class="button download" download="etiquetas.pdf">Descargar Etiquetas Dirección</a>
                <a href="{{ url_for('main.generar_etiquetas_or') }}" id="btn-download-or" class="button download secondary" download="etiquetas_or.pdf">Descargar Etiquetas OR</a>
            </div>
        </section>
        {% endif %}
    </div>

    <script>
    // Variables para ordenación
    let sortDirection = {}; 

    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("dataTable");
        switching = true;
        
        // Set sort direction
        if (!sortDirection[n] || sortDirection[n] === 'desc') {
            dir = "asc";
            sortDirection[n] = 'asc';
        } else {
            dir = "desc";
            sortDirection[n] = 'desc';
        }

        while (switching) {
            switching = false;
            rows = table.rows;
            
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                
                // Get input elements
                var xInput = rows[i].getElementsByTagName("TD")[n].querySelector('input');
                var yInput = rows[i + 1].getElementsByTagName("TD")[n].querySelector('input');
                
                // Get values based on input type
                if (xInput.type === "checkbox") {
                    x = xInput.checked ? "1" : "0";
                    y = yInput.checked ? "1" : "0";
                } else {
                    x = xInput.value.toLowerCase();
                    y = yInput.value.toLowerCase();
                }

                if (dir == "asc") {
                    if (x > y) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (x < y) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            }
        }
    }

    // Función para actualizar enlaces y preview con offsets
    function updateLinks() {
        const offX = document.getElementById('offset-x').value;
        const offY = document.getElementById('offset-y').value;
        const query = `?offset_x=${offX}&offset_y=${offY}`;
        const timeParam = '&t=' + new Date().getTime(); // Prevent caching

        // Actualizar iframe
        const iframe = document.getElementById('pdf-preview');
        if(iframe) {
            // Mantener la ruta base actual (dirección u OR) pero cambiando params
            let currentBase = iframe.src.split('?')[0];
            iframe.src = currentBase + query + timeParam;
        }

        // Actualizar botones de descarga
        const btnAddr = document.getElementById('btn-download-addr');
        if(btnAddr) btnAddr.href = "{{ url_for('main.generar_pdf') }}" + query;

        const btnOr = document.getElementById('btn-download-or');
        if(btnOr) btnOr.href = "{{ url_for('main.generar_etiquetas_or') }}" + query;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const editarForm = document.getElementById('editar-form');
        const loading = document.getElementById('loading');
        const statusMessage = document.getElementById('status-message');
        const sheetsForm = document.getElementById('sheets-form');
        const submitBtn = document.getElementById('submit-btn');

        if (sheetsForm) {
            sheetsForm.addEventListener('submit', function(e) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Cargando...';
            });
        }

        if (editarForm) {
            editarForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Show loading indicator
                loading.style.display = 'flex';
                document.getElementById('save-btn').disabled = true;

                // Collect form data
                const rows = Array.from(document.querySelectorAll('tbody tr'));
                const data = rows.map(row => {
                    const inputs = row.querySelectorAll('input');
                    return {
                        "Enviar": inputs[0].checked,
                        "Nombre": inputs[1].value.trim(),
                        "Empresa": inputs[2].value.trim(),
                        "Dirección": inputs[3].value.trim(),
                        "CP": inputs[4].value.trim(),
                        "Ciudad": inputs[5].value.trim(),
                        "Zona": inputs[6].value.trim(),
                        "Producto": inputs[7].value.trim(),
                        "País": inputs[8].value.trim(),
                        "Internacional": inputs[9].checked
                    };
                });

                // Send data to server
                fetch('/editar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                })
                .then(res => res.json())
                .then(data => {
                    loading.style.display = 'none';
                    document.getElementById('save-btn').disabled = false;

                    if (data.ok) {
                        updateLinks(); // Refresh PDF preview with current offsets
                        statusMessage.textContent = 'Datos guardados correctamente';
                        statusMessage.className = 'alert success';
                        statusMessage.style.display = 'block';
                        setTimeout(() => { statusMessage.style.display = 'none'; }, 3000);
                    } else {
                        statusMessage.textContent = data.error || 'Error al guardar los datos';
                        statusMessage.className = 'alert error';
                        statusMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                    document.getElementById('save-btn').disabled = false;
                    statusMessage.textContent = 'Error de conexión';
                    statusMessage.className = 'alert error';
                    statusMessage.style.display = 'block';
                });
            });
        }
    });
    </script>
</body>
</html>