<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de etiquetas postales</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Salvajetiquetas</h1>
            <p class="subtitle">Generador de etiquetas para envíos postales</p>
        </header>

        <section class="form-section">
            <form method="POST" id="sheets-form">
                <div class="form-group">
                    <label for="sheet_url">URL de Google Sheets:</label>
                    <div class="input-group">
                        <input type="text" name="sheet_url" id="sheet_url" required
                                placeholder="https://docs.google.com/spreadsheets/d/..."
                                pattern=".*docs\.google\.com\/spreadsheets\/d\/.*"
                                title="Introduce una URL válida de Google Sheets">
                        <button type="submit" id="submit-btn">Cargar hoja</button>
                    </div>
                    <small class="form-help">La hoja debe estar compartida con permisos de lectura</small>
                </div>
            </form>
        </section>

        {% if error %}
        <div class="alert error" role="alert">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        {% if success %}
        <div class="alert success" role="alert">
            {{ success }}
        </div>
        {% endif %}

        {% if preview %}
        <section class="data-section">
            <h2>Editar datos antes de generar etiquetas</h2>
            <p class="instructions">Pulsa en los encabezados para ordenar. Revisa y edita los datos antes de imprimir.</p>

            <form id="editar-form">
                <div class="table-container">
                    <table class="editable" id="dataTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">¿Env? <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(1)">Nombre <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(2)">Empresa <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(3)">Dirección <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(4)">CP <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(5)">Ciudad <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(6)">Z <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(7)">Env. <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(8)">País <span class="sort-icon">⇅</span></th>
                                <th onclick="sortTable(9)">¿Int? <span class="sort-icon">⇅</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in preview %}
                            <tr>
                                <td><input type="checkbox" name="Enviar" {% if row.Enviar in [True, 'True', 'true', '1', 'sí', 'si'] %}checked{% endif %}></td>
                                <td><input type="text" name="Nombre" value="{{ row.Nombre }}"></td>
                                <td><input type="text" name="Empresa" value="{{ row.Empresa }}"></td>
                                <td><input type="text" name="Dirección" value="{{ row.Dirección }}"></td>
                                <td><input type="text" name="CP" value="{{ row.CP }}"></td>
                                <td><input type="text" name="Ciudad" value="{{ row.Ciudad }}"></td>
                                <td><input type="text" name="Zona" value="{{ row.Zona }}"></td>
                                <td><input type="text" name="Producto" value="{{ row.Producto|replace('.0', '') }}"></td>
                                <td><input type="text" name="País" value="{{ row.País }}"></td>
                                <td><input type="checkbox" name="Internacional" {% if row.Internacional in [True, 'True', 'true', '1', 'sí', 'si'] %}checked{% endif %}></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button type="submit" id="save-btn" class="primary">Guardar y regenerar PDF</button>
                </div>
            </form>

            <div id="loading" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <span>Procesando...</span>
            </div>

            <div id="status-message" class="alert" style="display: none;"></div>
        </section>
        {% endif %}

        {% if success %}
        <section class="preview-section">
            <h2>Previsualización y Descarga</h2>

            <div class="calibration-panel">
                <h3>Ajustes de Impresión (Calibración)</h3>
                <p class="small-text">
                    <strong>Nota:</strong> Estos ajustes se guardan automáticamente y 
                    <u>solo aplican a las Etiquetas de Dirección</u>. Las etiquetas OR son fijas.
                </p>
                <div class="calibration-controls">
                    <div class="control-group">
                        <label for="offset-x">Desplazar X (mm):</label>
                        <input type="number" id="offset-x" value="0" step="0.5" oninput="debouncedUpdate()">
                        <span class="hint">+ Der / - Izq</span>
                    </div>
                    <div class="control-group">
                        <label for="offset-y">Desplazar Y (mm):</label>
                        <input type="number" id="offset-y" value="0" step="0.5" oninput="debouncedUpdate()">
                        <span class="hint">+ Arr / - Abj</span>
                    </div>
                    <div class="control-group">
                        <label for="delta-w">Margen Lateral (mm):</label>
                        <input type="number" id="delta-w" value="0" step="0.1" oninput="debouncedUpdate()">
                        <span class="hint">Encoger ancho</span>
                    </div>
                    <div class="control-group">
                        <label for="delta-h">Margen Vertical (mm):</label>
                        <input type="number" id="delta-h" value="0" step="0.1" oninput="debouncedUpdate()">
                        <span class="hint">Encoger alto</span>
                    </div>
                    <div class="control-group" style="width: auto; align-self: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="show-guides" onchange="updateLinks()">
                            <label for="show-guides" style="margin: 0; cursor: pointer;"><strong>Ver Guías (Cortes)</strong></label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pdf-container">
                <iframe id="pdf-preview" src="{{ url_for('main.generar_pdf') }}" width="100%" height="600px"></iframe>
            </div>

            <div class="button-group downloads">
                <a href="{{ url_for('main.generar_pdf') }}" id="btn-download-addr" class="button download" download="etiquetas.pdf">Descargar Etiquetas Dirección</a>
                <a href="{{ url_for('main.generar_etiquetas_or') }}" id="btn-download-or" class="button download secondary" download="etiquetas_or.pdf">Descargar Etiquetas OR</a>
            </div>
        </section>
        {% endif %}
    </div>

    <script>
    // --- Lógica de Ordenación de Tablas ---
    let sortDirection = {}; 

    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("dataTable");
        switching = true;

        if (!sortDirection[n] || sortDirection[n] === 'desc') {
            dir = "asc";
            sortDirection[n] = 'asc';
        } else {
            dir = "desc";
            sortDirection[n] = 'desc';
        }

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                var xInput = rows[i].getElementsByTagName("TD")[n].querySelector('input');
                var yInput = rows[i + 1].getElementsByTagName("TD")[n].querySelector('input');

                if (xInput.type === "checkbox") {
                    x = xInput.checked ? "1" : "0";
                    y = yInput.checked ? "1" : "0";
                } else {
                    x = xInput.value.toLowerCase();
                    y = yInput.value.toLowerCase();
                }

                if (dir == "asc") {
                    if (x > y) { shouldSwitch = true; break; }
                } else if (dir == "desc") {
                    if (x < y) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            }
        }
    }

    // --- Persistencia de Ajustes (LocalStorage) ---
    function saveSettings() {
        const settings = {
            offsetX: document.getElementById('offset-x').value,
            offsetY: document.getElementById('offset-y').value,
            deltaW: document.getElementById('delta-w').value,
            deltaH: document.getElementById('delta-h').value,
            guides: document.getElementById('show-guides').checked
        };
        localStorage.setItem('salvaje_settings', JSON.stringify(settings));
    }

    function loadSettings() {
        const saved = localStorage.getItem('salvaje_settings');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                if(document.getElementById('offset-x')) {
                    document.getElementById('offset-x').value = settings.offsetX || 0;
                    document.getElementById('offset-y').value = settings.offsetY || 0;
                    document.getElementById('delta-w').value = settings.deltaW || 0;
                    document.getElementById('delta-h').value = settings.deltaH || 0;
                    document.getElementById('show-guides').checked = settings.guides || false;
                    // Forzar actualización inicial
                    updateLinks();
                }
            } catch (e) {
                console.error("Error cargando ajustes", e);
            }
        }
    }

    // --- Actualización de PDF ---
    let timeout = null;
    function debouncedUpdate() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            saveSettings(); // Guardar al dejar de escribir
            updateLinks();
        }, 500);
    }

    function updateLinks() {
        const offX = document.getElementById('offset-x').value;
        const offY = document.getElementById('offset-y').value;
        const deltaW = document.getElementById('delta-w').value;
        const deltaH = document.getElementById('delta-h').value;
        const guides = document.getElementById('show-guides').checked ? "1" : "0";

        // Guardar checkbox también si cambia
        if(timeout === null) saveSettings();

        // Parámetros SOLO para direcciones
        const query = `?offset_x=${offX}&offset_y=${offY}&delta_w=${deltaW}&delta_h=${deltaH}&guides=${guides}`;
        const timeParam = '&t=' + new Date().getTime();

        const iframe = document.getElementById('pdf-preview');
        const btnAddr = document.getElementById('btn-download-addr');
        const btnOr = document.getElementById('btn-download-or');

        // Actualizar IFRAME (Solo si está mostrando etiquetas de dirección)
        // Si el usuario navegó manualmente a OR en el iframe, no queremos cambiarlo automágicamente
        if(iframe) {
            let currentSrc = iframe.src;
            // Si es la carga inicial o es el PDF de etiquetas
            if (currentSrc.includes('etiquetas.pdf') || !currentSrc.includes('.pdf')) {
                iframe.src = "{{ url_for('main.generar_pdf') }}" + query + timeParam;
            }
        }

        // El botón de direcciones lleva los ajustes
        if(btnAddr) btnAddr.href = "{{ url_for('main.generar_pdf') }}" + query;

        // El botón OR va LIMPIO (sin ajustes)
        if(btnOr) btnOr.href = "{{ url_for('main.generar_etiquetas_or') }}" + "?t=" + new Date().getTime();
    }

    // --- Inicialización ---
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar ajustes guardados
        loadSettings();

        const editarForm = document.getElementById('editar-form');
        const loading = document.getElementById('loading');
        const statusMessage = document.getElementById('status-message');
        const sheetsForm = document.getElementById('sheets-form');
        const submitBtn = document.getElementById('submit-btn');

        if (sheetsForm) {
            sheetsForm.addEventListener('submit', function(e) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Cargando...';
            });
        }

        if (editarForm) {
            editarForm.addEventListener('submit', function(e) {
                e.preventDefault();
                loading.style.display = 'flex';
                document.getElementById('save-btn').disabled = true;

                const rows = Array.from(document.querySelectorAll('tbody tr'));
                const data = rows.map(row => {
                    const inputs = row.querySelectorAll('input');
                    return {
                        "Enviar": inputs[0].checked,
                        "Nombre": inputs[1].value.trim(),
                        "Empresa": inputs[2].value.trim(),
                        "Dirección": inputs[3].value.trim(),
                        "CP": inputs[4].value.trim(),
                        "Ciudad": inputs[5].value.trim(),
                        "Zona": inputs[6].value.trim(),
                        "Producto": inputs[7].value.trim(),
                        "País": inputs[8].value.trim(),
                        "Internacional": inputs[9].checked
                    };
                });

                fetch('/editar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: data })
                })
                .then(res => res.json())
                .then(data => {
                    loading.style.display = 'none';
                    document.getElementById('save-btn').disabled = false;

                    if (data.ok) {
                        updateLinks();
                        statusMessage.textContent = 'Datos guardados correctamente';
                        statusMessage.className = 'alert success';
                        statusMessage.style.display = 'block';
                        setTimeout(() => { statusMessage.style.display = 'none'; }, 3000);
                    } else {
                        statusMessage.textContent = data.error || 'Error al guardar los datos';
                        statusMessage.className = 'alert error';
                        statusMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                    document.getElementById('save-btn').disabled = false;
                    statusMessage.textContent = 'Error de conexión';
                    statusMessage.className = 'alert error';
                    statusMessage.style.display = 'block';
                });
            });
        }
    });
    </script>
</body>
</html>